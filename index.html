<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sync Measurement App</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background-color: #222; color: #fff; overflow: hidden; }
  #videoContainer {
    position: relative;
    width: 100%;
    height: calc(100vh - 350px); /* Adjust for control panel and debug log height */
    background-color: #000;
  }
  #videoElement {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
  #crosshair {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    margin-left: -20px;
    margin-top: -20px;
    border: 2px solid red;
    border-radius: 50%;
    transition: border-color 0.2s;
  }
  #controls {
    position: relative;
    width: 100%;
    background-color: #111;
    padding: 10px;
    box-sizing: border-box;
  }
  #deltaDisplay {
    font-size: 24px;
    margin-top: 10px;
    text-align: center;
  }
  #startButton {
    padding: 10px 20px;
    font-size: 18px;
    width: 100%;
  }
  #sliders {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
  }
  .slider-container {
    flex: 1;
    margin: 0 5px;
  }
  .slider-container label {
    display: block;
    text-align: center;
  }
  .slider-container input[type="range"] {
    width: 100%;
  }
  #meters {
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
  }
  .meter-container {
    flex: 1;
    margin: 0 5px;
    text-align: center;
  }
  .meter {
    width: 100%;
    height: 20px;
    background-color: #555;
    position: relative;
    margin-top: 5px;
  }
  .meter-fill {
    height: 100%;
    background-color: lime;
    width: 0%;
  }
  .meter-threshold {
    position: absolute;
    top: -2px;
    width: 2px;
    height: 24px;
    background-color: red;
  }
  #debugLog {
    overflow-y: scroll;
    height: 100px;
    background-color: #333;
    color: #fff;
    padding: 10px;
    font-size: 12px;
    box-sizing: border-box;
    white-space: pre-wrap;
  }
  canvas { display: none; }
</style>
</head>
<body>

<div id="videoContainer">
  <video id="videoElement" autoplay playsinline></video>
  <canvas id="videoCanvas"></canvas>
  <div id="overlay">
    <div id="crosshair"></div>
  </div>
</div>

<div id="controls">
  <button id="startButton">Start Measurement</button>
  <div id="sliders">
    <div class="slider-container">
      <label for="brightnessThreshold">Brightness Threshold: <span id="brightnessValue">250</span></label>
      <input type="range" id="brightnessThreshold" min="0" max="255" value="250">
    </div>
    <div class="slider-container">
      <label for="volumeThreshold">Volume Threshold: <span id="volumeValue">15</span></label>
      <input type="range" id="volumeThreshold" min="0" max="100" value="15">
    </div>
  </div>
  <div id="meters">
    <div class="meter-container">
      <div>Brightness Level</div>
      <div class="meter" id="brightnessMeter">
        <div class="meter-fill" id="brightnessFill"></div>
        <div class="meter-threshold" id="brightnessMeterThreshold"></div>
      </div>
    </div>
    <div class="meter-container">
      <div>Volume Level</div>
      <div class="meter" id="volumeMeter">
        <div class="meter-fill" id="volumeFill"></div>
        <div class="meter-threshold" id="volumeMeterThreshold"></div>
      </div>
    </div>
  </div>
  <div id="deltaDisplay">Delta: -- ms</div>
</div>

<div id="debugLog"></div>

<script>
// Override console.log to display messages on the page
(function() {
  var oldConsoleLog = console.log;
  console.log = function(message) {
    oldConsoleLog.apply(console, arguments);
    var debugLog = document.getElementById('debugLog');
    if (debugLog) {
      if (typeof message === 'object') {
        message = JSON.stringify(message);
      }
      debugLog.innerHTML += message + '<br>';
      debugLog.scrollTop = debugLog.scrollHeight; // Auto-scroll to bottom
    }
  };
})();

let video = document.getElementById('videoElement');
let canvas = document.getElementById('videoCanvas');
let deltaDisplay = document.getElementById('deltaDisplay');
let startButton = document.getElementById('startButton');
let crosshair = document.getElementById('crosshair');

let brightnessThresholdInput = document.getElementById('brightnessThreshold');
let volumeThresholdInput = document.getElementById('volumeThreshold');
let brightnessValueDisplay = document.getElementById('brightnessValue');
let volumeValueDisplay = document.getElementById('volumeValue');

let brightnessMeterFill = document.getElementById('brightnessFill');
let volumeMeterFill = document.getElementById('volumeFill');
let brightnessMeterThreshold = document.getElementById('brightnessMeterThreshold');
let volumeMeterThreshold = document.getElementById('volumeMeterThreshold');

let videoStream;
let audioStream;
let audioContext;
let scriptProcessor;
let audioInitialized = false;

let lastFlashTime = null;
let lastBeepTime = null;

let running = false;

let brightnessThreshold = parseInt(brightnessThresholdInput.value);
let volumeThreshold = parseInt(volumeThresholdInput.value);

let lastBrightnessOver​⬤